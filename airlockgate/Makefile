.PHONY: fire pull
.PHONY: run-java-gate kill-java build-java

VERSION := 1.0
RELEASE := $(shell git describe --always --tags | awk -F- '{ if ($$2) dot="."} END { printf "%s%s%s\n",$$2,dot,$$3}')
VENDOR := "SKB Kontur"
LICENSE := MIT
URL := https://github.com/vostok-project/airlock


MAXRPS=1000
TESTDUR=1200
EVENTSIZE=10
GATEPORT=8888
LANG=Java
REV=$(shell git rev-parse --short HEAD)

JAVA_COMMON_PARAMS = -Xms16g -Xmx16g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -jar ./target/vostok-airlock-gate-1.0-SNAPSHOT.jar

run-java-gate: build-java
	java ${JAVA_COMMON_PARAMS} 

kill-java:
	pgrep java | awk '{system("kill -9 "$$1)}'

build:
	mvn clean package

build-java: pull build

fire: pull
	echo "[phantom]"                                                                            > autogenerated.ini
	echo "headers = [Host: icat-test04]"                                                          >> autogenerated.ini
	echo "address = icat-test04:${GATEPORT}"                                                      >> autogenerated.ini
	echo "rps_schedule = line(1, ${MAXRPS}, 60s) const(${MAXRPS}, ${TESTDUR}s)"                   >> autogenerated.ini
	echo "ammofile = ammo${EVENTSIZE}"                   >> autogenerated.ini
	echo "[telegraf]"                                                                             >> autogenerated.ini
	echo "config = monitoring.xml"                                                                >> autogenerated.ini
	echo "[overload]"                                                                             >> autogenerated.ini
	echo "token_file = token.txt"                                                                 >> autogenerated.ini
	echo "ver = ${REV}"                                                                           >> autogenerated.ini
	echo "job_name = Airlock-${LANG}, event size ${EVENTSIZE}, version ${REV}"                                              >> autogenerated.ini
	echo "job_dsc = line(1, ${MAXRPS}, 60s) const(${MAXRPS}, ${TESTDUR}s)"                        >> autogenerated.ini
	echo "<Monitoring>"                                                                           >  monitoring.xml
	for host in icat-test01 icat-test02 icat-test03 ; do \
		echo "  <Host address=\"$$host\" comment=\"$$host\">"                                     >> monitoring.xml ; \
		echo "    <CPU />"                                                                        >> monitoring.xml ; \
		echo "    <Memory />"                                                                     >> monitoring.xml ; \
		echo "    <Disk devices='[\"sda3\",\"sda4\"]'></Disk>"                                    >> monitoring.xml ; \
		echo "    <Net interfaces='[\"team0\"]'></Net>"                                           >> monitoring.xml ; \
		echo "    <Netstat />"                                                                    >> monitoring.xml ; \
		echo "  </Host>"                                                                          >> monitoring.xml ; \
	done
	for host in icat-test04 ; do \
		echo "  <Host address=\"$$host\" comment=\"$$host\">"                                     >> monitoring.xml ; \
		echo "    <Custom diff=\"1\" measure=\"call\" label=\"throughput-events-sec\">curl -s http://$$host:8888/th</Custom>" >> monitoring.xml ; \
		echo "    <Custom diff=\"1\" measure=\"call\" label=\"throughput-kb-sec\">curl -s http://$$host:8888/thkb</Custom>" >> monitoring.xml ; \
		echo "  </Host>"                                                                          >> monitoring.xml ; \
	done
	echo "</Monitoring>"                                                                          >> monitoring.xml
	yandex-tank -c autogenerated.ini

pull:
	git pull


clean:
	@rm -rf build

tar:
	mkdir -p build/root/usr/lib/vostok/airlock
	mv /target/vostok-airlock-gate-$(VERSION)-SNAPSHOT.jar build/root/usr/lib/vostok/airlock/gate.jar
	tar -czvPf build/vostok-airlock-gate-$(VERSION).$(RELEASE).tar.gz -C build/root  .

rpm:
	fpm -t rpm \
		-s "tar" \
		--description "Vostok Airlock Gate" \
		--vendor $(VENDOR) \
		--url $(URL) \
		--license $(LICENSE) \
		--name "vostok-airlock-gate" \
		--version $(VERSION) \
		--iteration "$(RELEASE)" \
		-p build \
		build/vostok-airlock-gate-$(VERSION).$(RELEASE).tar.gz

deb:
	fpm -t deb \
		-s "tar" \
		--description "Vostok Airlock Gate" \
		--vendor $(VENDOR) \
		--url $(URL) \
		--license $(LICENSE) \
		--name "vostok-airlock-gate" \
		--version "$(VERSION)" \
		--iteration "$(RELEASE)" \
		-p build \
		build/vostok-airlock-gate-$(VERSION).$(RELEASE).tar.gz

packages: clean build tar rpm deb
